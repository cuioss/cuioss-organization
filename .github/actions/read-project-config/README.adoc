= Read project.yml Configuration Action

Parses `.github/project.yml` and outputs configuration values with sensible defaults for cuioss reusable workflows.

== Features

* Single-step configuration reading (no separate checkout required)
* Field registry pattern for easy expansion
* JSON Schema for IDE autocomplete and validation
* Graceful defaults when fields are missing

== Usage

=== Basic Usage

[source,yaml]
----
- uses: actions/checkout@v4
  with:
    sparse-checkout: .github/project.yml
    sparse-checkout-cone-mode: false

- name: Read project.yml configuration
  id: config
  uses: cuioss/cuioss-organization/.github/actions/read-project-config@6a5470e3e9d597b7edf34907476a373bceee31b3 # v0.3.1

- name: Use configuration
  run: |
    echo "Java version: ${{ steps.config.outputs.java-version }}"
    echo "Sonar enabled: ${{ steps.config.outputs.sonar-enabled }}"
----

=== Custom Config Path

[source,yaml]
----
- uses: cuioss/cuioss-organization/.github/actions/read-project-config@6a5470e3e9d597b7edf34907476a373bceee31b3 # v0.3.1
  id: config
  with:
    config-path: 'custom/path/project.yml'
----

== Inputs

|===
| Input | Description | Default

| `config-path`
| Path to project.yml file
| `.github/project.yml`
|===

== Outputs

=== Maven Build Section

|===
| Output | Default | Description

| `java-versions`
| `'["21","25"]'`
| JSON array of Java versions for matrix build

| `java-version`
| `'21'`
| Primary Java version

| `enable-snapshot-deploy`
| `'true'`
| Deploy snapshots to Maven Central

| `maven-profiles-snapshot`
| `'release-snapshot,javadoc'`
| Maven profiles for snapshot deployment

| `maven-profiles-release`
| `'release,javadoc'`
| Maven profiles for release

| `npm-cache`
| `'false'`
| Enable npm package caching
|===

=== Sonar Section

|===
| Output | Default | Description

| `sonar-enabled`
| `'true'`
| Enable SonarCloud analysis

| `sonar-skip-on-dependabot`
| `'true'`
| Skip Sonar for Dependabot PRs

| `sonar-project-key`
| `''`
| SonarCloud project key
|===

=== Release Section

|===
| Output | Default | Description

| `current-version`
| `''`
| Current release version

| `next-version`
| `''`
| Next development version

| `create-github-release`
| `'false'`
| Create a GitHub Release with auto-generated notes
|===

=== Pages Section

|===
| Output | Default | Description

| `pages-reference`
| `''`
| Folder on cuioss.github.io

| `deploy-site`
| `'true'`
| Deploy Maven site at release
|===

=== Integration Tests Section

|===
| Output | Default | Description

| `it-test-type`
| `''`
| Type of integration tests (`java-it` or `playwright-e2e`)

| `it-maven-module`
| `''`
| Maven module containing integration tests

| `it-maven-profiles`
| `'integration-tests'`
| Maven profiles for integration tests

| `it-timeout-minutes`
| `'20'`
| Timeout in minutes for the test job

| `it-deploy-reports`
| `'false'`
| Deploy test reports to cuioss.github.io

| `it-reports-subfolder`
| `''`
| Subfolder on cuioss.github.io for test reports
|===

=== Pyprojectx Section

|===
| Output | Default | Description

| `pyprojectx-python-version`
| `''`
| Python version (empty = let uv manage from pyproject.toml)

| `pyprojectx-cache-dependency-glob`
| `'uv.lock'`
| Glob pattern for uv cache dependencies

| `pyprojectx-upload-artifacts-on-failure`
| `'false'`
| Upload test artifacts on failure

| `pyprojectx-verify-command`
| `'./pw verify'`
| Verification command to run
|===

=== GitHub Automation Section

|===
| Output | Default | Description

| `auto-merge-build-versions`
| `'true'`
| Auto-merge consumer repo workflow update PRs when CI passes

| `auto-merge-build-timeout`
| `'300'`
| Timeout in seconds for waiting on CI checks before auto-merge
|===

=== Other

|===
| Output | Default | Description

| `consumers`
| `''`
| Space-separated consumer repos

| `config-found`
| -
| Whether project.yml exists

| `custom-keys`
| `''`
| Space-separated list of custom field keys

| `custom-<key>`
| -
| Dynamic outputs for each custom field
|===

== Custom Fields (Downstream Extension)

Downstream repos can define arbitrary fields in a `custom` namespace without modifying this action.

=== project.yml in consumer repo

[source,yaml]
----
name: my-downstream-repo

custom:
  skip-e2e: true
  deploy-target: staging
  timeout-minutes: 30
----

=== Resulting outputs

|===
| Output | Value

| `custom-keys`
| `skip-e2e deploy-target timeout-minutes`

| `custom-skip-e2e`
| `true`

| `custom-deploy-target`
| `staging`

| `custom-timeout-minutes`
| `30`
|===

=== Usage in workflow

[source,yaml]
----
- uses: cuioss/cuioss-organization/.github/actions/read-project-config@6a5470e3e9d597b7edf34907476a373bceee31b3 # v0.3.1
  id: config

- name: Run E2E tests
  if: steps.config.outputs.custom-skip-e2e != 'true'
  run: npm run test:e2e

- name: Deploy to ${{ steps.config.outputs.custom-deploy-target }}
  run: ./deploy.sh --target ${{ steps.config.outputs.custom-deploy-target }}
  timeout-minutes: ${{ steps.config.outputs.custom-timeout-minutes }}
----

== IDE Autocomplete

Add this comment to your `project.yml` for IDE autocomplete support:

[source,yaml]
----
# yaml-language-server: $schema=https://raw.githubusercontent.com/cuioss/cuioss-organization/main/.github/actions/read-project-config/schema.json
name: my-project
# ...
----

== Adding New Fields

To add a new configuration field, edit `read-config.py` and add one line to `FIELD_REGISTRY`:

[source,python]
----
FIELD_REGISTRY.append(
    (["section", "field-name"], "output-name", "default-value", None)
)
----

Then add the corresponding output in `action.yml`.

== Local Testing

[source,bash]
----
cd .github/actions/read-project-config
python3 read-config.py --config ../../../.github/project.yml
----
