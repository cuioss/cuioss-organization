name: Pyprojectx Verify (Reusable)
# Reusable workflow for projects using pyprojectx (pw) build system

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use (empty = let uv manage)'
        required: false
        type: string
        default: ''
      cache-dependency-glob:
        description: 'Glob pattern for uv cache dependencies'
        required: false
        type: string
        default: 'uv.lock'
      upload-artifacts-on-failure:
        description: 'Upload test artifacts on failure'
        required: false
        type: boolean
        default: false
      verify-command:
        description: 'Verification command to run'
        required: false
        type: string
        default: './pw verify'

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Read project.yml configuration
        id: config
        uses: cuioss/cuioss-organization/.github/actions/read-project-config@c4852ae3c12a7adcbddbf140043b832ff5e6bc97 # v0.5.2

      - name: Set up Python ${{ steps.config.outputs.pyprojectx-python-version || inputs.python-version }}
        if: ${{ (steps.config.outputs.pyprojectx-python-version || inputs.python-version) != '' }}
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: ${{ steps.config.outputs.pyprojectx-python-version || inputs.python-version }}

      - name: Set up uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: true
          cache-dependency-glob: ${{ steps.config.outputs.pyprojectx-cache-dependency-glob || inputs.cache-dependency-glob }}

      - name: Run verification
        run: ${{ steps.config.outputs.pyprojectx-verify-command || inputs.verify-command }}

      - name: Upload test results
        if: ${{ failure() && (steps.config.outputs.pyprojectx-upload-artifacts-on-failure == 'true' || inputs.upload-artifacts-on-failure) }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: test-results
          path: |
            .pytest_cache/
            .mypy_cache/
          retention-days: 5
