name: Maven Build (Reusable)

on:
  workflow_call:
    inputs:
      java-versions:
        description: 'JSON array of Java versions to test'
        required: false
        type: string
        default: '["21","25"]'
      enable-sonar:
        description: 'Enable SonarCloud analysis'
        required: false
        type: boolean
        default: true
      enable-snapshot-deploy:
        description: 'Deploy snapshots to Maven Central'
        required: false
        type: boolean
        default: true
      npm-cache:
        description: 'Enable npm package caching'
        required: false
        type: boolean
        default: false
      maven-profiles-snapshot:
        description: 'Maven profiles for snapshot deployment'
        required: false
        type: string
        default: 'release-snapshot,javadoc'
      skip-sonar-on-dependabot:
        description: 'Skip Sonar analysis for Dependabot PRs'
        required: false
        type: boolean
        default: true
      java-version:
        description: 'Java version for Sonar analysis and snapshot deploy'
        required: false
        type: string
        default: '21'
    secrets:
      SONAR_TOKEN:
        required: false
      OSS_SONATYPE_USERNAME:
        required: false
      OSS_SONATYPE_PASSWORD:
        required: false
      GPG_PRIVATE_KEY:
        required: false
      GPG_PASSPHRASE:
        required: false

permissions:
  contents: read

jobs:
  # Read project.yml configuration to use as defaults
  config:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      java-versions: ${{ steps.config.outputs.java-versions }}
      java-version: ${{ steps.config.outputs.java-version }}
      enable-snapshot-deploy: ${{ steps.config.outputs.enable-snapshot-deploy }}
      maven-profiles-snapshot: ${{ steps.config.outputs.maven-profiles-snapshot }}
      npm-cache: ${{ steps.config.outputs.npm-cache }}
      sonar-enabled: ${{ steps.config.outputs.sonar-enabled }}
      skip-sonar-on-dependabot: ${{ steps.config.outputs.skip-sonar-on-dependabot }}
      sonar-project-key: ${{ steps.config.outputs.sonar-project-key }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          sparse-checkout: .github/project.yml
          sparse-checkout-cone-mode: false

      - name: Read project.yml configuration
        id: config
        run: |
          CONFIG_FILE=".github/project.yml"
          if [ -f "$CONFIG_FILE" ]; then
            # Extract values using yq, with defaults
            JAVA_VERSIONS=$(yq -r '.["maven-build"]["java-versions"] // ""' "$CONFIG_FILE")
            JAVA_VERSION=$(yq -r '.["maven-build"]["java-version"] // ""' "$CONFIG_FILE")
            ENABLE_SNAPSHOT=$(yq -r '.["maven-build"]["enable-snapshot-deploy"] // ""' "$CONFIG_FILE")
            MAVEN_PROFILES=$(yq -r '.["maven-build"]["maven-profiles-snapshot"] // ""' "$CONFIG_FILE")
            NPM_CACHE=$(yq -r '.["maven-build"]["npm-cache"] // ""' "$CONFIG_FILE")
            SONAR_ENABLED=$(yq -r '.sonar.enabled // ""' "$CONFIG_FILE")
            SKIP_SONAR_DEPENDABOT=$(yq -r '.sonar["skip-on-dependabot"] // ""' "$CONFIG_FILE")
            SONAR_PROJECT_KEY=$(yq -r '.sonar["project-key"] // ""' "$CONFIG_FILE")

            echo "java-versions=$JAVA_VERSIONS" >> $GITHUB_OUTPUT
            echo "java-version=$JAVA_VERSION" >> $GITHUB_OUTPUT
            echo "enable-snapshot-deploy=$ENABLE_SNAPSHOT" >> $GITHUB_OUTPUT
            echo "maven-profiles-snapshot=$MAVEN_PROFILES" >> $GITHUB_OUTPUT
            echo "npm-cache=$NPM_CACHE" >> $GITHUB_OUTPUT
            echo "sonar-enabled=$SONAR_ENABLED" >> $GITHUB_OUTPUT
            echo "skip-sonar-on-dependabot=$SKIP_SONAR_DEPENDABOT" >> $GITHUB_OUTPUT
            echo "sonar-project-key=$SONAR_PROJECT_KEY" >> $GITHUB_OUTPUT
          fi

  build:
    needs: config
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        version: ${{ fromJson(needs.config.outputs.java-versions || inputs.java-versions) }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK ${{ matrix.version }}
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: ${{ matrix.version }}
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Cache npm packages
        if: ${{ needs.config.outputs.npm-cache == 'true' || inputs.npm-cache }}
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Build with Maven, Java ${{ matrix.version }}
        run: ./mvnw --no-transfer-progress verify -Dmaven.compiler.release=${{ matrix.version }}

  sonar-build:
    needs: [config, build]
    if: ${{ (needs.config.outputs.sonar-enabled != 'false' && inputs.enable-sonar) && !((needs.config.outputs.skip-sonar-on-dependabot == 'true' || inputs.skip-sonar-on-dependabot) && github.actor == 'dependabot[bot]') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ needs.config.outputs.java-version || inputs.java-version }} for Sonar-build
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: ${{ needs.config.outputs.java-version || inputs.java-version }}
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Cache SonarCloud packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache npm packages
        if: ${{ needs.config.outputs.npm-cache == 'true' || inputs.npm-cache }}
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Build and analyze
        env:
          GITHUB_TOKEN: ${{ github.token }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./mvnw -B --no-transfer-progress verify -Psonar -Dsonar.projectKey=${{ needs.config.outputs.sonar-project-key }} sonar:sonar

  deploy-snapshot:
    needs: [config, sonar-build]
    if: ${{ always() && (needs.config.outputs.enable-snapshot-deploy != 'false' && inputs.enable-snapshot-deploy) && github.ref == format('refs/heads/{0}', github.event.repository.default_branch) && (needs.sonar-build.result == 'success' || needs.sonar-build.result == 'skipped') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK ${{ needs.config.outputs.java-version || inputs.java-version }} for snapshot release
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: ${{ needs.config.outputs.java-version || inputs.java-version }}
          distribution: 'temurin'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE
          cache: maven

      - name: Cache npm packages
        if: ${{ needs.config.outputs.npm-cache == 'true' || inputs.npm-cache }}
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Extract project version
        id: project
        run: echo "version=$(./mvnw --no-transfer-progress help:evaluate -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_OUTPUT

      - name: Deploy Snapshot with Maven, version ${{ steps.project.outputs.version }}
        if: ${{ endsWith(steps.project.outputs.version, '-SNAPSHOT') }}
        run: |
          ./mvnw -B --no-transfer-progress -P${{ needs.config.outputs.maven-profiles-snapshot || inputs.maven-profiles-snapshot }} deploy -Dmaven.test.skip=true
        env:
          MAVEN_USERNAME: ${{ secrets.OSS_SONATYPE_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSS_SONATYPE_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
