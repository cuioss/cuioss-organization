name: Maven Build (Reusable)

on:
  workflow_call:
    inputs:
      java-versions:
        description: 'JSON array of Java versions to test'
        required: false
        type: string
        default: '["21","25"]'
      enable-sonar:
        description: 'Enable SonarCloud analysis'
        required: false
        type: boolean
        default: true
      enable-snapshot-deploy:
        description: 'Deploy snapshots to Maven Central'
        required: false
        type: boolean
        default: true
      npm-cache:
        description: 'Enable npm package caching'
        required: false
        type: boolean
        default: false
      maven-profiles-snapshot:
        description: 'Maven profiles for snapshot deployment'
        required: false
        type: string
        default: 'release-snapshot,javadoc'
      skip-sonar-on-dependabot:
        description: 'Skip Sonar analysis for Dependabot PRs'
        required: false
        type: boolean
        default: true
      java-version:
        description: 'Java version for Sonar analysis and snapshot deploy'
        required: false
        type: string
        default: '21'
      skip-on-docs-only:
        description: 'Skip build when only documentation/config files changed'
        required: false
        type: boolean
        default: true
      paths-ignore-extra:
        description: 'Space-separated extra glob patterns to treat as non-code'
        required: false
        type: string
        default: ''
    secrets:
      SONAR_TOKEN:
        required: false
      OSS_SONATYPE_USERNAME:
        required: false
      OSS_SONATYPE_PASSWORD:
        required: false
      GPG_PRIVATE_KEY:
        required: false
      GPG_PASSPHRASE:
        required: false

permissions:
  contents: read

jobs:
  # Read project.yml configuration to use as defaults
  config:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      java-versions: ${{ steps.config.outputs.java-versions }}
      java-version: ${{ steps.config.outputs.java-version }}
      enable-snapshot-deploy: ${{ steps.config.outputs.enable-snapshot-deploy }}
      maven-profiles-snapshot: ${{ steps.config.outputs.maven-profiles-snapshot }}
      npm-cache: ${{ steps.config.outputs.npm-cache }}
      sonar-enabled: ${{ steps.config.outputs.sonar-enabled }}
      sonar-skip-on-dependabot: ${{ steps.config.outputs.sonar-skip-on-dependabot }}
      sonar-project-key: ${{ steps.config.outputs.sonar-project-key }}
      skip-on-docs-only: ${{ steps.config.outputs.skip-on-docs-only }}
      paths-ignore-extra: ${{ steps.config.outputs.paths-ignore-extra }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          sparse-checkout: .github/project.yml
          sparse-checkout-cone-mode: false

      - name: Read project.yml configuration
        id: config
        uses: cuioss/cuioss-organization/.github/actions/read-project-config@10e359dfd5cff4bb6fd758dcbe4692d6f70d2b03 # v0.6.0

  # Check if only documentation/config files changed (skip build if so)
  check-changes:
    needs: config
    if: needs.config.outputs.skip-on-docs-only != 'false' && inputs.skip-on-docs-only
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      should-build: ${{ steps.filter.outputs.code }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Build paths-filter spec
        id: build-filter
        env:
          EXTRA: ${{ needs.config.outputs.paths-ignore-extra }}
        run: |
          {
            echo 'spec<<EOF'
            echo 'code:'
            echo "  - '!**/*.adoc'"
            echo "  - '!**/*.md'"
            echo "  - '!doc/**'"
            echo "  - '!.github/project.yml'"
            echo "  - '!.github/dependabot.yml'"
            echo "  - '!LICENSE'"
            echo "  - '!NOTICE'"
            for pattern in $EXTRA; do
              echo "  - '!$pattern'"
            done
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: ${{ steps.build-filter.outputs.spec }}

  build:
    needs: [config, check-changes]
    if: always() && needs.check-changes.outputs.should-build != 'false' && needs.config.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        version: ${{ fromJson(needs.config.outputs.java-versions || inputs.java-versions) }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK ${{ matrix.version }}
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: ${{ matrix.version }}
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Cache npm packages
        if: ${{ needs.config.outputs.npm-cache == 'true' || inputs.npm-cache }}
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Build with Maven, Java ${{ matrix.version }}
        run: ./mvnw --no-transfer-progress verify -Dmaven.compiler.release=${{ matrix.version }}

  sonar-build:
    needs: [config, check-changes, build]
    if: ${{ always() && needs.check-changes.outputs.should-build != 'false' && needs.build.result == 'success' && (needs.config.outputs.sonar-enabled != 'false' && inputs.enable-sonar) && !((needs.config.outputs.sonar-skip-on-dependabot == 'true' || inputs.skip-sonar-on-dependabot) && github.actor == 'dependabot[bot]') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ needs.config.outputs.java-version || inputs.java-version }} for Sonar-build
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: ${{ needs.config.outputs.java-version || inputs.java-version }}
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Cache SonarCloud packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache npm packages
        if: ${{ needs.config.outputs.npm-cache == 'true' || inputs.npm-cache }}
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Build and analyze
        env:
          GITHUB_TOKEN: ${{ github.token }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./mvnw -B --no-transfer-progress verify -Psonar -Dsonar.projectKey=${{ needs.config.outputs.sonar-project-key }} -Dsonar.qualitygate.wait=true sonar:sonar

  deploy-snapshot:
    needs: [config, check-changes, sonar-build]
    if: ${{ always() && needs.check-changes.outputs.should-build != 'false' && (needs.config.outputs.enable-snapshot-deploy != 'false' && inputs.enable-snapshot-deploy) && github.ref == format('refs/heads/{0}', github.event.repository.default_branch) && (needs.sonar-build.result == 'success' || needs.sonar-build.result == 'skipped') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK ${{ needs.config.outputs.java-version || inputs.java-version }} for snapshot release
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: ${{ needs.config.outputs.java-version || inputs.java-version }}
          distribution: 'temurin'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE
          cache: maven

      - name: Cache npm packages
        if: ${{ needs.config.outputs.npm-cache == 'true' || inputs.npm-cache }}
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Extract project version
        id: project
        run: echo "version=$(./mvnw --no-transfer-progress help:evaluate -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_OUTPUT

      - name: Deploy Snapshot with Maven, version ${{ steps.project.outputs.version }}
        if: ${{ endsWith(steps.project.outputs.version, '-SNAPSHOT') }}
        run: |
          ./mvnw -B --no-transfer-progress -P${{ needs.config.outputs.maven-profiles-snapshot || inputs.maven-profiles-snapshot }} deploy -Dmaven.test.skip=true
        env:
          MAVEN_USERNAME: ${{ secrets.OSS_SONATYPE_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSS_SONATYPE_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
