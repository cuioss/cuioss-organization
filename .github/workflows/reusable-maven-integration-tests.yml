name: Maven Integration Tests (Reusable)
# Reusable workflow for integration/E2E tests with optional report deployment.
# Callers pass Maven arguments (not arbitrary commands) for security.

on:
  workflow_call:
    inputs:
      report-name:
        description: 'Base name for the report (used in artifact and deploy directory names)'
        required: true
        type: string
      maven-args-input:
        description: |
          Newline-separated Maven arguments. Each line becomes a separate
          ./mvnw -B --no-transfer-progress <line> invocation.
          Example:
            install -DskipTests -pl dependencies-bom
            verify -Pintegration-tests -pl e-2-e-playwright -am
        required: true
        type: string
      install-playwright:
        description: 'Install Playwright browsers before running tests'
        required: false
        type: boolean
        default: false
      reports-folder:
        description: |
          Newline-separated list of directories to include in the report.
          Example:
            e-2-e-playwright/target/results-selftests
            e-2-e-playwright/target/results-functional-tests
        required: true
        type: string
      report-logs:
        description: |
          Newline-separated list of log files to include in the report.
          Example:
            e-2-e-playwright/target/keycloak-container.log
            e-2-e-playwright/target/nifi-container.log
        required: false
        type: string
        default: ''
      timeout-minutes:
        description: 'Timeout in minutes for the test job'
        required: false
        type: number
        default: 20
      deploy-reports:
        description: 'Deploy assembled reports to cuioss.github.io'
        required: false
        type: boolean
        default: true
      max-report-runs:
        description: 'Maximum number of report runs to keep on GitHub Pages (oldest removed first)'
        required: false
        type: number
        default: 5
      skip-on-docs-only:
        description: 'Skip tests when only documentation/config files changed'
        required: false
        type: boolean
        default: true
      paths-ignore-extra:
        description: 'Space-separated extra glob patterns to treat as non-code'
        required: false
        type: string
        default: ''
      npm-cache:
        description: 'Enable npm package caching'
        required: false
        type: boolean
        default: false
    secrets:
      RELEASE_APP_ID:
        required: false
      RELEASE_APP_PRIVATE_KEY:
        required: false

permissions:
  contents: read

jobs:
  # Read project.yml configuration to use as defaults
  config:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      java-version: ${{ steps.config.outputs.java-version }}
      npm-cache: ${{ steps.config.outputs.npm-cache }}
      skip-on-docs-only: ${{ steps.config.outputs.skip-on-docs-only }}
      paths-ignore-extra: ${{ steps.config.outputs.paths-ignore-extra }}
      pages-reference: ${{ steps.config.outputs.pages-reference }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          sparse-checkout: .github/project.yml
          sparse-checkout-cone-mode: false

      - name: Read project.yml configuration
        id: config
        uses: cuioss/cuioss-organization/.github/actions/read-project-config@b1762e6052dfd4cfbb4a05d85804ec0a59e272d0 # v0.3.8

  # Check if only documentation/config files changed (skip tests if so)
  check-changes:
    needs: config
    if: needs.config.outputs.skip-on-docs-only != 'false' && inputs.skip-on-docs-only
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      should-test: ${{ steps.filter.outputs.code }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Build paths-filter spec
        id: build-filter
        env:
          EXTRA: ${{ needs.config.outputs.paths-ignore-extra }}
        run: |
          {
            echo 'spec<<EOF'
            echo 'code:'
            echo "  - '!**/*.adoc'"
            echo "  - '!**/*.md'"
            echo "  - '!doc/**'"
            echo "  - '!.github/project.yml'"
            echo "  - '!.github/dependabot.yml'"
            echo "  - '!LICENSE'"
            echo "  - '!NOTICE'"
            for pattern in $EXTRA; do
              echo "  - '!$pattern'"
            done
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: ${{ steps.build-filter.outputs.spec }}

  test:
    needs: [config, check-changes]
    if: always() && needs.check-changes.outputs.should-test != 'false' && needs.config.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJson(inputs.timeout-minutes) }}
    permissions:
      contents: read

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Generate App Token
        id: app-token
        if: ${{ inputs.deploy-reports && ((github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) || github.event_name == 'workflow_dispatch') }}
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
          repositories: ${{ github.event.repository.name }},cuioss.github.io
          owner: cuioss

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up JDK ${{ needs.config.outputs.java-version }}
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: ${{ needs.config.outputs.java-version }}
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Cache npm packages
        if: ${{ needs.config.outputs.npm-cache == 'true' || inputs.npm-cache }}
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install Playwright browsers
        if: ${{ inputs.install-playwright }}
        run: npx playwright install --with-deps

      - name: Validate and run Maven commands
        env:
          MAVEN_ARGS_INPUT: ${{ inputs.maven-args-input }}
        run: |
          while IFS= read -r line; do
            line=$(echo "$line" | xargs)  # trim whitespace
            [ -z "$line" ] && continue
            # Validate against safe pattern (Maven arguments only)
            if ! echo "$line" | grep -qE '^[a-zA-Z0-9_./:,=@-][a-zA-Z0-9_./:,=@ -]*$'; then
              echo "::error::Invalid maven-args-input line (unsafe characters): $line"
              exit 1
            fi
            echo ">>> ./mvnw -B --no-transfer-progress $line"
            ./mvnw -B --no-transfer-progress $line
          done <<< "$MAVEN_ARGS_INPUT"

      - name: Assemble test reports
        id: assemble-reports
        if: always()
        uses: cuioss/cuioss-organization/.github/actions/assemble-test-reports@b1762e6052dfd4cfbb4a05d85804ec0a59e272d0 # v0.3.8
        with:
          report-name: ${{ inputs.report-name }}
          reports-folder: ${{ inputs.reports-folder }}
          report-logs: ${{ inputs.report-logs }}

      - name: Upload test artifacts
        if: always() && steps.assemble-reports.outputs.report-dir != ''
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ steps.assemble-reports.outputs.report-dirname }}
          path: ${{ steps.assemble-reports.outputs.report-dir }}
          retention-days: 7

      - name: Generate step summary
        if: always() && steps.assemble-reports.outputs.report-dir != ''
        env:
          REPORT_DIRNAME: ${{ steps.assemble-reports.outputs.report-dirname }}
          REPORT_DIR: ${{ steps.assemble-reports.outputs.report-dir }}
          PAGES_REF: ${{ needs.config.outputs.pages-reference }}
          DEPLOY: ${{ inputs.deploy-reports }}
          REPO: ${{ github.event.repository.name }}
        run: |
          echo "## Integration Test Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** \`$REPORT_DIRNAME\`" >> $GITHUB_STEP_SUMMARY
          # List assembled report contents
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Contents:**" >> $GITHUB_STEP_SUMMARY
          for entry in "$REPORT_DIR"/*/; do
            [ -d "$entry" ] && echo "- \`$(basename "$entry")\`" >> $GITHUB_STEP_SUMMARY
          done
          for entry in "$REPORT_DIR"/logs/*; do
            [ -f "$entry" ] && echo "- \`logs/$(basename "$entry")\`" >> $GITHUB_STEP_SUMMARY
          done
          # Link to Pages deployment if applicable
          if [ "$DEPLOY" = "true" ] && [ -n "$PAGES_REF" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Pages:** https://cuioss.github.io/$PAGES_REF/$REPORT_DIRNAME/" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Checkout cuioss.github.io
        if: ${{ always() && inputs.deploy-reports && steps.assemble-reports.outputs.report-dir != '' && steps.app-token.outputs.token && ((github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) || github.event_name == 'workflow_dispatch') }}
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: cuioss/cuioss.github.io
          path: _pages-deploy
          sparse-checkout: ${{ needs.config.outputs.pages-reference }}
          token: ${{ steps.app-token.outputs.token }}

      - name: Deploy reports and cleanup old runs
        if: ${{ always() && inputs.deploy-reports && steps.assemble-reports.outputs.report-dir != '' && steps.app-token.outputs.token && ((github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) || github.event_name == 'workflow_dispatch') }}
        env:
          REPORT_DIR: ${{ steps.assemble-reports.outputs.report-dir }}
          REPORT_NAME: ${{ inputs.report-name }}
          TARGET_DIR: _pages-deploy/${{ needs.config.outputs.pages-reference }}
          MAX_RUNS: ${{ inputs.max-report-runs }}
        run: |
          # Ensure target directory exists
          mkdir -p "$TARGET_DIR"

          # Copy new report into pages checkout
          cp -r "$REPORT_DIR" "$TARGET_DIR/"

          # Cleanup: keep only newest MAX_RUNS report directories
          cd "$TARGET_DIR"
          DIRS=$(ls -d ${REPORT_NAME}-* 2>/dev/null | sort)
          COUNT=$(echo "$DIRS" | grep -c . || true)
          if [ "$COUNT" -gt "$MAX_RUNS" ]; then
            REMOVE=$((COUNT - MAX_RUNS))
            echo "$DIRS" | head -n "$REMOVE" | xargs rm -rf
            echo "Cleaned up $REMOVE old report(s), keeping newest $MAX_RUNS"
          fi

      - name: Generate report directory indexes
        if: ${{ always() && inputs.deploy-reports && steps.assemble-reports.outputs.report-dir != '' && steps.app-token.outputs.token && ((github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) || github.event_name == 'workflow_dispatch') }}
        uses: gacts/directory-listing@b7ce8063c2a35a7c2c910847a674fafc48ea0512 # v1.0.3
        with:
          target: _pages-deploy/${{ needs.config.outputs.pages-reference }}

      - name: Commit and push reports
        if: ${{ always() && inputs.deploy-reports && steps.assemble-reports.outputs.report-dir != '' && steps.app-token.outputs.token && ((github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) || github.event_name == 'workflow_dispatch') }}
        env:
          TARGET_DIR: _pages-deploy/${{ needs.config.outputs.pages-reference }}
          PAGES_TITLE: ${{ needs.config.outputs.pages-reference }}
          REPORT_DIRNAME: ${{ steps.assemble-reports.outputs.report-dirname }}
        run: |
          # Generate overview index (groups reports by name, newest first)
          python3 ".test-reports/generate-overview-index.py" \
            --target-dir "$TARGET_DIR" \
            --title "$PAGES_TITLE"

          # Commit and push
          cd _pages-deploy
          git config user.name "cuioss-release-bot[bot]"
          git config user.email "cuioss-release-bot[bot]@users.noreply.github.com"
          git add .
          git diff --staged --quiet || git commit -m "Deploy test reports: $REPORT_DIRNAME"
          git push
