name: Maven Release (Reusable)
# Reusable workflow for Maven releases to Maven Central

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '21'
      maven-profiles:
        description: 'Maven profiles for release (comma-separated)'
        required: false
        type: string
        default: 'release,javadoc'
      deploy-site:
        description: 'Deploy Maven site to GitHub Pages'
        required: false
        type: boolean
        default: true
    secrets:
      RELEASE_APP_ID:
        required: true
      RELEASE_APP_PRIVATE_KEY:
        required: true
      OSS_SONATYPE_USERNAME:
        required: true
      OSS_SONATYPE_PASSWORD:
        required: true
      GPG_PRIVATE_KEY:
        required: true
      GPG_PASSPHRASE:
        required: true

permissions:
  contents: read

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      released-version: ${{ steps.config.outputs.current-version }}
      consumers: ${{ steps.config.outputs.consumers }}
      dep-prop-group-id: ${{ steps.config.outputs.dep-prop-group-id }}
      dep-prop-artifact-id: ${{ steps.config.outputs.dep-prop-artifact-id }}
      dep-prop-scope: ${{ steps.config.outputs.dep-prop-scope }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Generate Release Token
        id: release-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
          repositories: ${{ github.event.repository.name }},cuioss.github.io
          owner: cuioss

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ steps.release-token.outputs.token }}
          fetch-depth: 0

      - name: Read project.yml configuration
        id: config
        uses: cuioss/cuioss-organization/.github/actions/read-project-config@e48599b588d0cf2652b982de998a52b21d9ae5ac # v0.5.3

      - name: Set up JDK ${{ steps.config.outputs.java-version || inputs.java-version }}
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: ${{ steps.config.outputs.java-version || inputs.java-version }}
          distribution: 'temurin'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE
          cache: maven

      - name: Cache npm packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Configure Git author
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "cuioss-release-bot"

      - name: Maven release ${{ steps.config.outputs.current-version }}
        run: |
          git checkout -b release
          ./mvnw -B --no-transfer-progress -P${{ steps.config.outputs.maven-profiles-release || inputs.maven-profiles }} release:clean release:prepare \
            -DreleaseVersion=${{ steps.config.outputs.current-version }} \
            -DdevelopmentVersion=${{ steps.config.outputs.next-version }}
          # Install SNAPSHOT artifacts to local repo for multi-module site generation
          ./mvnw -B --no-transfer-progress install -DskipTests
          ./mvnw -B --no-transfer-progress -P${{ steps.config.outputs.maven-profiles-release || inputs.maven-profiles }} site:site site:stage
          git checkout ${{ github.ref_name }}
          git rebase release
          ./mvnw -B --no-transfer-progress -P${{ steps.config.outputs.maven-profiles-release || inputs.maven-profiles }} release:perform -DskipTests
        env:
          MAVEN_USERNAME: ${{ secrets.OSS_SONATYPE_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSS_SONATYPE_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Deploy Maven Site
        if: ${{ steps.config.outputs.deploy-site != 'false' && inputs.deploy-site }}
        uses: JamesIves/github-pages-deploy-action@d92aa235d04922e8f08b40ce78cc5442fcfbfa2f # v4.8.0
        with:
          folder: target/site
          repository-name: cuioss/cuioss.github.io
          target-folder: ${{ steps.config.outputs.pages-reference }}
          branch: main
          token: ${{ steps.release-token.outputs.token }}

      - name: Push changes
        uses: ad-m/github-push-action@77c5b412c50b723d2a4fbc6d71fb5723bcd439aa # v1.0.0
        with:
          github_token: ${{ steps.release-token.outputs.token }}
          branch: ${{ github.ref_name }}
          force: true

      - name: Push tag ${{ steps.config.outputs.current-version }}
        uses: ad-m/github-push-action@77c5b412c50b723d2a4fbc6d71fb5723bcd439aa # v1.0.0
        with:
          github_token: ${{ steps.release-token.outputs.token }}
          branch: ${{ github.ref_name }}
          tags: true
          force: true

      - name: Create GitHub Release
        if: ${{ steps.config.outputs.create-github-release == 'true' }}
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          token: ${{ steps.release-token.outputs.token }}
          tag_name: ${{ steps.config.outputs.current-version }}
          name: ${{ steps.config.outputs.current-version }}
          generate_release_notes: true
          make_latest: true

  # Wait for the released artifact to appear on Maven Central before propagating
  wait-for-maven-central:
    needs: [release]
    if: >-
      success() &&
      needs.release.outputs.consumers != '' &&
      needs.release.outputs.dep-prop-group-id != '' &&
      needs.release.outputs.dep-prop-artifact-id != ''
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
    outputs:
      found: ${{ steps.wait.outputs.found }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: cuioss/cuioss-organization
          ref: e48599b588d0cf2652b982de998a52b21d9ae5ac # v0.5.3
          sparse-checkout: workflow-scripts

      - name: Wait for Maven Central
        id: wait
        run: |
          python3 workflow-scripts/check-maven-central.py \
            --group-id "${{ needs.release.outputs.dep-prop-group-id }}" \
            --artifact-id "${{ needs.release.outputs.dep-prop-artifact-id }}" \
            --version "${{ needs.release.outputs.released-version }}" \
            --timeout 1800

  # Propagate the new version to consumer repositories
  propagate-to-consumers:
    needs: [release, wait-for-maven-central]
    if: >-
      always() &&
      needs.release.result == 'success' &&
      needs.release.outputs.consumers != '' &&
      needs.release.outputs.dep-prop-group-id != '' &&
      needs.release.outputs.dep-prop-artifact-id != ''
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Generate Propagation Token
        id: prop-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
          owner: cuioss

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: cuioss/cuioss-organization
          ref: e48599b588d0cf2652b982de998a52b21d9ae5ac # v0.5.3
          sparse-checkout: workflow-scripts

      - name: Update consumer repos
        id: update-consumers
        env:
          GH_TOKEN: ${{ steps.prop-token.outputs.token }}
        run: |
          VERSION="${{ needs.release.outputs.released-version }}"
          GROUP_ID="${{ needs.release.outputs.dep-prop-group-id }}"
          ARTIFACT_ID="${{ needs.release.outputs.dep-prop-artifact-id }}"
          SCOPE="${{ needs.release.outputs.dep-prop-scope }}"

          # Collect results for summary
          RESULTS_FILE=$(mktemp)
          echo "RESULTS_FILE=$RESULTS_FILE" >> "$GITHUB_OUTPUT"
          echo "[]" > "$RESULTS_FILE"

          for CONSUMER in ${{ needs.release.outputs.consumers }}; do
            # Parse optional version-property hint: "repo-name:property.name"
            REPO="${CONSUMER%%:*}"
            HINT="${CONSUMER#*:}"
            if [ "$HINT" = "$CONSUMER" ]; then
              HINT=""
            fi

            echo "::group::Propagating to $REPO${HINT:+ (property: $HINT)}"
            EXTRA_ARGS=""
            if [ -n "$HINT" ]; then
              EXTRA_ARGS="--version-property $HINT"
            fi
            OUTPUT=$(python3 workflow-scripts/update-consumer-dependency.py \
              --repo "$REPO" \
              --group-id "$GROUP_ID" \
              --artifact-id "$ARTIFACT_ID" \
              --new-version "$VERSION" \
              --scope "$SCOPE" \
              $EXTRA_ARGS 2>&1) || true
            echo "$OUTPUT"

            # Extract RESULT JSON line
            RESULT_LINE=$(echo "$OUTPUT" | grep '^RESULT:' | sed 's/^RESULT://')
            if [ -n "$RESULT_LINE" ]; then
              jq --arg repo "$REPO" --argjson result "$RESULT_LINE" \
                '. += [{"repo": $repo} + $result]' "$RESULTS_FILE" > "${RESULTS_FILE}.tmp" \
                && mv "${RESULTS_FILE}.tmp" "$RESULTS_FILE"
            fi
            echo "::endgroup::"
          done

          # Build propagation summary
          MAVEN_CENTRAL_FOUND="${{ needs.wait-for-maven-central.outputs.found }}"
          {
            echo "## Dependency Propagation Summary"
            echo ""
            echo "**Artifact:** \`${GROUP_ID}:${ARTIFACT_ID}:${VERSION}\`"
            echo "**Scope:** ${SCOPE}"
            echo ""
            if [ "$MAVEN_CENTRAL_FOUND" = "true" ]; then
              echo ":white_check_mark: Artifact confirmed on Maven Central before propagation"
            elif [ "$MAVEN_CENTRAL_FOUND" = "false" ]; then
              echo ":warning: Artifact NOT confirmed on Maven Central (timeout) â€” PRs created anyway"
            else
              echo ":grey_question: Maven Central wait status unknown"
            fi
            echo ""

            echo "### Consumer Repository Updates"
            echo ""
            echo "| Repository | Status | PR |"
            echo "|---|---|---|"

            jq -r '.[] |
              if .status == "pr_auto_merge_enabled" then
                "| " + .repo + " | :hourglass: Auto-merge enabled | [PR](" + (.pr_url // "-") + ") |"
              elif .status == "pr_created" then
                "| " + .repo + " | :arrow_right: PR Created | [PR](" + (.pr_url // "-") + ") |"
              elif .status == "no_changes" then
                "| " + .repo + " | :heavy_minus_sign: No Changes | - |"
              else
                "| " + .repo + " | :x: Error | " + (.error // "unknown") + " |"
              end' "$RESULTS_FILE"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Verify consumer PR merges
        continue-on-error: true
        env:
          GH_TOKEN: ${{ steps.prop-token.outputs.token }}
        run: |
          RESULTS_FILE="${{ steps.update-consumers.outputs.RESULTS_FILE }}"
          if [ -n "$RESULTS_FILE" ] && [ -f "$RESULTS_FILE" ]; then
            python3 workflow-scripts/verify-consumer-prs.py \
              --results-file "$RESULTS_FILE" \
              --timeout 300
            rm -f "$RESULTS_FILE"
          else
            echo "No results file found, skipping verification"
          fi
