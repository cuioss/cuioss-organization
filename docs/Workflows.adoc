= Reusable Workflows
:toc:

== Overview

Centralized GitHub Actions workflows for all cuioss repositories.

Eliminates copy-paste duplication and centralizes action version management.

== Workflow Triggers and Duplicate Prevention

All cuioss caller workflows use a consistent trigger pattern:

[source,yaml]
----
on:
  push:
    branches: [main, "feature/*", "fix/*", "chore/*", "dependabot/**"]
  pull_request:
    branches: [main]

jobs:
  build:
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
    uses: cuioss/cuioss-organization/.github/workflows/reusable-maven-build.yml@3432f9e01cf089f24d3718468d28c5fbd9fe78d9 # v0.3.6
----

=== Why This Pattern?

* **`push` to `main`, `feature/*`, `fix/*`, `chore/*`, and `dependabot/**`**: Ensures all commits are verified, including early pushes to feature/fix/chore branches and dependabot updates before a PR is opened.
* **`pull_request` to `main`**: Verifies all pull requests targeting the main branch, especially important for fork PRs.

=== Avoiding Duplicate Runs

When you push to a feature branch that has an open PR, both triggers fire simultaneously:

1. `push` trigger: "A push to `feature/*` occurred"
2. `pull_request` trigger: "The PR was updated"

The `if` condition on the job prevents duplicate runs by checking the event type and repository:

[source,yaml]
----
if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
----

This means:

* **Push events**: Always run (handles internal branch pushes)
* **Pull request events**: Only run if from a **fork** (external contributors)

For internal branches, the push event already verifies the code, so we skip the redundant PR event.
For fork PRs, the push event cannot trigger (forks can't trigger push events on the base repo), so we run the PR event.

=== Path Filtering for Documentation-Only Changes

The reusable Maven build workflow includes a built-in `check-changes` job using https://github.com/dorny/paths-filter[dorny/paths-filter] that skips build/sonar/deploy jobs when only documentation or config files changed. This is handled entirely inside `reusable-maven-build.yml` — callers do not need any path filtering logic.

**Built-in ignored patterns:** `+**/*.adoc+`, `+**/*.md+`, `doc/**`, `.github/project.yml`, `.github/dependabot.yml`, `LICENSE`, `NOTICE`

Repos with additional non-code directories can extend the ignore list via `project.yml`:

[source,yaml]
----
maven-build:
  skip-on-docs-only: true          # default: true — master switch
  paths-ignore-extra:               # additional patterns to treat as non-code
    - 'e-2-e-playwright/docs/**'
----

This approach is preferred over workflow-level `paths-ignore` because `paths-ignore` prevents the entire workflow from running, which causes required status checks to never report — blocking PR merges. With the internal gate job, the caller's `build` job always runs and reports success whether the reusable workflow builds or skips, satisfying branch protection.

NOTE: We intentionally do not use workflow-level `concurrency` with `cancel-in-progress` because GitHub has a https://github.com/orgs/community/discussions/8336[known bug] where cancelled workflows appear as "failed" in PR checks, blocking merges.

== Available Workflows

[cols="1,2,1"]
|===
|Workflow |Purpose |Typical Lines Saved

|`reusable-maven-build.yml`
|Main build, Sonar analysis, snapshot deploy
|~100 → ~15

|`reusable-maven-release.yml`
|Release to Maven Central with GPG signing
|~100 → ~15

|`reusable-maven-integration-tests.yml`
|Integration/E2E tests with optional report deployment
|~80 → ~15

|`reusable-scorecards.yml`
|OpenSSF Scorecard supply-chain security
|~80 → ~12

|`reusable-dependency-review.yml`
|Dependency vulnerability scanning on PRs
|~30 → ~10

|`reusable-pyprojectx-verify.yml`
|Python/pyprojectx build verification
|~45 → ~10

|`reusable-npm-build.yml`
|Node.js npm build, lint, test, Sonar analysis
|~80 → ~12

|`reusable-npm-publish.yml`
|Publish to npm with OIDC trusted publishing
|~80 → ~12
|===

== Configuration via project.yml

Consumer repositories can define build and release settings in `.github/project.yml` instead of passing explicit workflow inputs.

=== Example project.yml

[source,yaml]
----
name: my-project
description: My Java project

release:
  current-version: 1.0.0
  next-version: 1.1.0-SNAPSHOT

maven-build:
  java-versions: '["21","25"]'
  java-version: '21'

sonar:
  project-key: cuioss_my-project

pages:
  reference: my-project
----

For full schema documentation, see link:project-yml-schema.adoc[project-yml-schema.adoc].

== Maven Build

=== Basic Usage

[source,yaml]
----
# Configuration is read from .github/project.yml - no inputs needed!
# Path filtering is handled inside the reusable workflow via project.yml settings.
name: Maven Build

on:
  push:
    branches: [main, "feature/*", "fix/*", "chore/*", "release/*", "dependabot/**"]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
    uses: cuioss/cuioss-organization/.github/workflows/reusable-maven-build.yml@3432f9e01cf089f24d3718468d28c5fbd9fe78d9 # v0.3.6
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      OSS_SONATYPE_USERNAME: ${{ secrets.OSS_SONATYPE_USERNAME }}
      OSS_SONATYPE_PASSWORD: ${{ secrets.OSS_SONATYPE_PASSWORD }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
----

=== Inputs (Optional - override project.yml)

[cols="1,1,1,2"]
|===
|Input |Type |Default |Description

|`java-versions`
|string
|`["21","25"]`
|JSON array of Java versions

|`enable-sonar`
|boolean
|`true`
|Enable SonarCloud analysis

|`enable-snapshot-deploy`
|boolean
|`true`
|Deploy snapshots to Maven Central

|`npm-cache`
|boolean
|`false`
|Cache npm packages (for frontend projects)

|`maven-profiles-snapshot`
|string
|`release-snapshot,javadoc`
|Profiles for snapshot deployment

|`skip-sonar-on-dependabot`
|boolean
|`true`
|Skip Sonar for Dependabot PRs

|`skip-on-docs-only`
|boolean
|`true`
|Skip build when only docs/config files changed

|`paths-ignore-extra`
|string
|``
|Space-separated extra globs to treat as non-code
|===

=== SonarCloud Quality Gate Enforcement

The `sonar-build` job waits for the SonarCloud Quality Gate result and fails if the gate fails.
This ensures PRs with insufficient coverage or other quality issues cannot pass CI with a green check.

* Quality Gate failure blocks the PR (sonar-build reports as failed)
* Snapshot deployment is skipped when sonar-build fails
* Dependabot PRs are unaffected (Sonar analysis is skipped for Dependabot by default)
* SonarCloud's default timeout of 300 seconds applies
* To disable Sonar analysis entirely, set `sonar.enabled: false` in `project.yml`

=== Required Secrets (All Organization-Level)

[cols="1,2"]
|===
|Secret |Required For

|`SONAR_TOKEN`
|Sonar analysis

|`OSS_SONATYPE_USERNAME`
|Snapshot deploy

|`OSS_SONATYPE_PASSWORD`
|Snapshot deploy

|`GPG_PRIVATE_KEY`
|Artifact signing

|`GPG_PASSPHRASE`
|Artifact signing
|===

== Maven Release

=== Basic Usage

[source,yaml]
----
# Configuration is read from .github/project.yml - no inputs needed!
name: Release

on:
  pull_request:
    types: [closed]
    paths: ['.github/project.yml']
  workflow_dispatch:

jobs:
  release:
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    uses: cuioss/cuioss-organization/.github/workflows/reusable-maven-release.yml@3432f9e01cf089f24d3718468d28c5fbd9fe78d9 # v0.3.6
    secrets:
      RELEASE_APP_ID: ${{ secrets.RELEASE_APP_ID }}
      RELEASE_APP_PRIVATE_KEY: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
      OSS_SONATYPE_USERNAME: ${{ secrets.OSS_SONATYPE_USERNAME }}
      OSS_SONATYPE_PASSWORD: ${{ secrets.OSS_SONATYPE_PASSWORD }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
----

=== Inputs (Optional - override project.yml)

[cols="1,1,1,2"]
|===
|Input |Type |Default |Description

|`java-version`
|string
|`21`
|Java version for release

|`maven-profiles`
|string
|`release,javadoc`
|Maven profiles to activate

|`deploy-site`
|boolean
|`true`
|Deploy Maven site to GitHub Pages
|===

=== Required Secrets

[cols="1,2"]
|===
|Secret |Description

|`RELEASE_APP_ID`
|cuioss-release-bot App ID

|`RELEASE_APP_PRIVATE_KEY`
|cuioss-release-bot private key

|`OSS_SONATYPE_USERNAME`
|Maven Central deployment

|`OSS_SONATYPE_PASSWORD`
|Maven Central deployment

|`GPG_PRIVATE_KEY`
|Artifact signing

|`GPG_PASSPHRASE`
|Artifact signing
|===

NOTE: Pages deployment uses the cuioss-release-bot app token (generated from `RELEASE_APP_ID` / `RELEASE_APP_PRIVATE_KEY`), not a separate PAT.

== Maven Integration Tests

=== Basic Usage (Java IT)

[source,yaml]
----
name: Integration Tests

on:
  push:
    branches: [main, "feature/*", "fix/*", "chore/*", "dependabot/**"]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  integration-tests:
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
    uses: cuioss/cuioss-organization/.github/workflows/reusable-maven-integration-tests.yml@3432f9e01cf089f24d3718468d28c5fbd9fe78d9 # v0.3.6
    with:
      test-type: java-it
      maven-module: my-it-module
    secrets:
      RELEASE_APP_ID: ${{ secrets.RELEASE_APP_ID }}
      RELEASE_APP_PRIVATE_KEY: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
----

=== Basic Usage (Playwright E2E)

[source,yaml]
----
name: E2E Tests

on:
  push:
    branches: [main, "feature/*", "fix/*", "chore/*", "dependabot/**"]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  e2e-tests:
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
    uses: cuioss/cuioss-organization/.github/workflows/reusable-maven-integration-tests.yml@3432f9e01cf089f24d3718468d28c5fbd9fe78d9 # v0.3.6
    with:
      test-type: playwright-e2e
      maven-module: e-2-e-playwright
    secrets:
      RELEASE_APP_ID: ${{ secrets.RELEASE_APP_ID }}
      RELEASE_APP_PRIVATE_KEY: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
----

=== Inputs

[cols="1,1,1,2"]
|===
|Input |Type |Default |Description

|`test-type`
|string
|-
|Type of tests: `java-it` or `playwright-e2e` (required)

|`maven-module`
|string
|-
|Maven module containing tests (required)

|`timeout-minutes`
|number
|`20`
|Timeout in minutes for the test job

|`maven-profiles`
|string
|`integration-tests`
|Maven profiles to activate

|`deploy-reports`
|boolean
|`true`
|Deploy test reports to cuioss.github.io

|`reports-subfolder`
|string
|``
|Subfolder on cuioss.github.io for reports

|`reports-folder`
|string
|-
|Newline-separated list of report directories (required)

|`skip-on-docs-only`
|boolean
|`true`
|Skip tests when only docs/config files changed

|`paths-ignore-extra`
|string
|``
|Space-separated extra globs to treat as non-code

|`npm-cache`
|boolean
|`false`
|Enable npm package caching
|===

=== Required Secrets

[cols="1,2"]
|===
|Secret |Required For

|`RELEASE_APP_ID`
|Report deployment (optional — only needed when `deploy-reports: true`)

|`RELEASE_APP_PRIVATE_KEY`
|Report deployment (optional — only needed when `deploy-reports: true`)
|===

NOTE: Pages deployment uses the cuioss-release-bot app token, not a PAT. Secrets are only required when `deploy-reports` is enabled.

== Scorecards

=== Basic Usage

[source,yaml]
----
name: Scorecard supply-chain security

on:
  branch_protection_rule:
  schedule:
    - cron: '20 7 * * 2'
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  analysis:
    uses: cuioss/cuioss-organization/.github/workflows/reusable-scorecards.yml@3432f9e01cf089f24d3718468d28c5fbd9fe78d9 # v0.3.6
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read
      issues: read
      pull-requests: read
      checks: read
----

=== Inputs

[cols="1,1,1,2"]
|===
|Input |Type |Default |Description

|`publish-results`
|boolean
|`true`
|Publish to OpenSSF
|===

== Dependency Review

=== Basic Usage

[source,yaml]
----
name: Dependency Review

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  dependency-review:
    uses: cuioss/cuioss-organization/.github/workflows/reusable-dependency-review.yml@3432f9e01cf089f24d3718468d28c5fbd9fe78d9 # v0.3.6
    permissions:
      contents: read
      pull-requests: write
----

=== Inputs

[cols="1,1,1,2"]
|===
|Input |Type |Default |Description

|`fail-on-severity`
|string
|`high`
|Minimum severity to fail

|`allow-licenses`
|string
|``
|Allowed licenses (comma-separated)

|`deny-licenses`
|string
|``
|Denied licenses (comma-separated)
|===

== Pyprojectx Verify

=== Basic Usage

[source,yaml]
----
name: Python Verify

on:
  push:
    branches: [main, "feature/*", "fix/*", "chore/*", "dependabot/**"]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  verify:
    # Run on push, OR on pull_request only if from a fork
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
    uses: cuioss/cuioss-organization/.github/workflows/reusable-pyprojectx-verify.yml@3432f9e01cf089f24d3718468d28c5fbd9fe78d9 # v0.3.6
----

=== Inputs

[cols="1,1,1,2"]
|===
|Input |Type |Default |Description

|`python-version`
|string
|`` (uv manages)
|Python version (leave empty to let uv manage from pyproject.toml)

|`cache-dependency-glob`
|string
|`uv.lock`
|Glob pattern for uv cache dependencies

|`upload-artifacts-on-failure`
|boolean
|`false`
|Upload test artifacts on failure

|`verify-command`
|string
|`./pw verify`
|Verification command to run
|===

=== No Secrets Required

This workflow does not require any secrets.

== npm Build

=== Basic Usage

[source,yaml]
----
# Configuration is read from .github/project.yml - no inputs needed!
name: npm Build

on:
  push:
    branches: [main, "feature/*", "fix/*", "chore/*", "dependabot/**"]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  build:
    # Run on push, OR on pull_request only if from a fork
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
    uses: cuioss/cuioss-organization/.github/workflows/reusable-npm-build.yml@3432f9e01cf089f24d3718468d28c5fbd9fe78d9 # v0.3.6
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
----

=== Inputs (Optional - override project.yml)

[cols="1,1,1,2"]
|===
|Input |Type |Default |Description

|`node-version`
|string
|`22`
|Node.js version

|`enable-sonar`
|boolean
|`true`
|Enable SonarCloud analysis

|`skip-sonar-on-dependabot`
|boolean
|`true`
|Skip Sonar for Dependabot PRs
|===

=== SonarCloud Quality Gate Enforcement

The `sonar-build` job waits for the SonarCloud Quality Gate result and fails if the gate fails.
This ensures PRs with insufficient coverage or other quality issues cannot pass CI with a green check.

* Quality Gate failure blocks the PR (sonar-build reports as failed)
* Dependabot PRs are unaffected (Sonar analysis is skipped for Dependabot by default)
* SonarCloud's default timeout of 300 seconds applies
* To disable Sonar analysis entirely, set `sonar.enabled: false` in `project.yml`

=== Required Secrets

[cols="1,2"]
|===
|Secret |Required For

|`SONAR_TOKEN`
|Sonar analysis (optional)
|===

== npm Publish

=== Basic Usage

[source,yaml]
----
# Configuration is read from .github/project.yml - no inputs needed!
name: Release

on:
  pull_request:
    types: [closed]
    paths: ['.github/project.yml']
  workflow_dispatch:

permissions:
  contents: read

jobs:
  release:
    permissions:
      contents: write
      id-token: write
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    uses: cuioss/cuioss-organization/.github/workflows/reusable-npm-publish.yml@3432f9e01cf089f24d3718468d28c5fbd9fe78d9 # v0.3.6
    secrets:
      RELEASE_APP_ID: ${{ secrets.RELEASE_APP_ID }}
      RELEASE_APP_PRIVATE_KEY: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
----

=== Inputs (Optional - override project.yml)

[cols="1,1,1,2"]
|===
|Input |Type |Default |Description

|`node-version`
|string
|`22`
|Node.js version for release
|===

=== Required Secrets

[cols="1,2"]
|===
|Secret |Description

|`RELEASE_APP_ID`
|cuioss-release-bot App ID

|`RELEASE_APP_PRIVATE_KEY`
|cuioss-release-bot private key
|===

=== No npm Token Required

This workflow uses **OIDC Trusted Publishing** — no long-lived npm tokens are stored anywhere.
GitHub's OIDC provider authenticates directly with npm during the publish step.
The caller workflow must grant `id-token: write` permission to enable this.

== Examples

See link:workflow-examples/[workflow-examples/] directory for complete caller workflow templates:

* link:workflow-examples/maven-build-caller.yml[maven-build-caller.yml] - Basic Maven build
* link:workflow-examples/maven-build-caller-custom.yml[maven-build-caller-custom.yml] - Maven build with custom options
* link:workflow-examples/maven-release-caller.yml[maven-release-caller.yml] - Maven release
* link:workflow-examples/scorecards-caller.yml[scorecards-caller.yml] - Scorecard analysis
* link:workflow-examples/dependency-review-caller.yml[dependency-review-caller.yml] - Dependency review
* link:workflow-examples/pyprojectx-verify-caller.yml[pyprojectx-verify-caller.yml] - Python/pyprojectx verification
* link:workflow-examples/npm-build-caller.yml[npm-build-caller.yml] - npm build
* link:workflow-examples/npm-publish-caller.yml[npm-publish-caller.yml] - npm publish (OIDC trusted publishing)

== Migration Guide

=== Step 1: Replace workflow file

Replace your repo's `~100 line` workflow with `~15 line` caller.

=== Step 2: Verify triggers

Ensure `on:` triggers match your repo's needs.

=== Step 3: Test

Run workflow manually via `workflow_dispatch` to verify.

== Action Version Management

All action versions are pinned centrally in this repo:

[cols="1,1"]
|===
|Action |Version

|`actions/checkout`
|v6.0.2

|`actions/setup-java`
|v5.2.0

|`step-security/harden-runner`
|v2.14.1

|`actions/cache`
|v5.0.3

|`actions/dependency-review-action`
|v4.8.2

|`github/codeql-action`
|v3.32.0

|`actions/github-script`
|v8

|`ossf/scorecard-action`
|v2.4.3

|`astral-sh/setup-uv`
|v7.2.1

|`softprops/action-gh-release`
|v2.5.0

|`actions/setup-node`
|v6.2.0

|`SonarSource/sonarqube-scan-action`
|v7.0.0
|===

To update versions: Edit the reusable workflows here, all repos inherit automatically.

Dependabot is configured to automatically create PRs for action updates (`.github/dependabot.yml`).
