= project.yml Schema for cuioss Consumer Repos

Central configuration file for cuioss reusable GitHub Actions workflows.

Consumer repositories can configure their build, release, and deployment settings in `.github/project.yml` instead of passing explicit inputs to workflow calls.

== IDE Autocomplete

For IDE autocomplete and validation support, add this comment at the top of your `project.yml`:

[source,yaml]
----
# yaml-language-server: $schema=https://raw.githubusercontent.com/cuioss/cuioss-organization/main/.github/actions/read-project-config/schema.json
----

== Quick Start

Create `.github/project.yml` in your repository:

[source,yaml]
----
# yaml-language-server: $schema=https://raw.githubusercontent.com/cuioss/cuioss-organization/main/.github/actions/read-project-config/schema.json
name: my-project
description: My Java project

release:
  current-version: 1.0.0
  next-version: 1.1.0-SNAPSHOT

sonar:
  project-key: cuioss_my-project
----

Then use minimal caller workflows:

[source,yaml]
----
# .github/workflows/maven.yml
name: Maven Build
on:
  push:
    branches: [main, "feature/*", "fix/*", "chore/*", "dependabot/**"]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  build:
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
    uses: cuioss/cuioss-organization/.github/workflows/reusable-maven-build.yml@89ce95e04b1e15076b0c8d78d8112fa432d9d162 # v0.3.11
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      OSS_SONATYPE_USERNAME: ${{ secrets.OSS_SONATYPE_USERNAME }}
      OSS_SONATYPE_PASSWORD: ${{ secrets.OSS_SONATYPE_PASSWORD }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
----

== Schema Reference

=== Required Fields

|===
|Field |Type |Description 

|`name` |string |Repository name 
|`release.current-version` |string |Current release version (semver) 
|`release.next-version` |string |Next development version (e.g., `1.1.0-SNAPSHOT`) 
|`sonar.project-key` |string |SonarCloud project key (required if Sonar enabled) 
|===

=== Optional Fields

==== Release Section

|===
|Field |Type |Default |Description

|`release.create-github-release` |boolean |`false` |Create GitHub Release with auto-generated notes
|===

==== Maven Build Section

|===
|Field |Type |Default |Description 

|`maven-build.java-versions` |string |`'["21","25"]'` |JSON array of Java versions for matrix build 
|`maven-build.java-version` |string |`'21'` |Primary Java version for Sonar, deploy, and release 
|`maven-build.enable-snapshot-deploy` |boolean |`true` |Deploy snapshots to Maven Central 
|`maven-build.maven-profiles-snapshot` |string |`'release-snapshot,javadoc'` |Maven profiles for snapshot deployment 
|`maven-build.maven-profiles-release` |string |`'release,javadoc'` |Maven profiles for release 
|`maven-build.npm-cache` |boolean |`false` |Enable npm package caching (for frontend projects)
|`maven-build.skip-on-docs-only` |boolean |`true` |Skip build when only documentation/config files changed
|`maven-build.paths-ignore-extra` |array |`[]` |Additional glob patterns to treat as non-code (beyond built-in defaults)
|===

==== Sonar Section

|===
|Field |Type |Default |Description 

|`sonar.enabled` |boolean |`true` |Enable SonarCloud analysis
|`sonar.skip-on-dependabot` |boolean |`true` |Skip Sonar analysis for Dependabot PRs
|===

NOTE: When Sonar is enabled, the build enforces the SonarCloud Quality Gate. A failing Quality Gate (e.g., insufficient test coverage) causes the `sonar-build` job to fail, which blocks the PR. For Maven projects, this also skips snapshot deployment. Set `sonar.enabled: false` to disable.

==== Pages Section

|===
|Field |Type |Default |Description

|`pages.reference` |string |- |Folder on cuioss.github.io for Maven site
|`pages.deploy-at-release` |boolean |`true` |Deploy Maven site to GitHub Pages during release
|===

==== Integration Tests Section

|===
|Field |Type |Default |Description

|`integration-tests.test-type` |string |- |Type of tests: `java-it` or `playwright-e2e`
|`integration-tests.maven-module` |string |- |Maven module containing integration tests
|`integration-tests.maven-profiles` |string |`'integration-tests'` |Maven profiles for integration tests
|`integration-tests.timeout-minutes` |integer |`20` |Timeout in minutes for the test job
|`integration-tests.deploy-reports` |boolean |`false` |Deploy test reports to cuioss.github.io
|`integration-tests.reports-subfolder` |string |- |Subfolder on cuioss.github.io for test reports
|`integration-tests.reports-folder` |string |- |Project-relative path to report folder for deployment
|===

==== npm Build Section

|===
|Field |Type |Default |Description

|`npm-build.node-version` |string |`'22'` |Node.js version for builds
|`npm-build.registry-url` |string |`'https://registry.npmjs.org'` |npm registry URL for publishing
|===

==== GitHub Automation Section

|===
|Field |Type |Default |Description

|`github-automation.auto-merge-build-versions` |boolean |`true` |Auto-merge workflow update PRs when CI checks pass
|===

==== Dependency Propagation Section

Controls automatic Maven dependency version updates to consumer repos after release.
Requires `consumers` list to be configured.

|===
|Field |Type |Default |Description

|`dependency-propagation.group-id` |string |- |Maven groupId of the artifact to propagate (e.g., `de.cuioss`)
|`dependency-propagation.artifact-id` |string |- |Maven artifactId to propagate (e.g., `cui-java-parent`)
|`dependency-propagation.scope` |string |`parent` |Update scope: `parent` (parent POM version) or `dependency` (dependency/property version)
|===

**Version Property Hints in `consumers` List**

For `scope: dependency`, each consumer entry **must** include a `:property-name` suffix that names the Maven property to update:

[source,yaml]
----
consumers:
  - cui-java-tools                                       # scope: parent (no hint needed)
  - cuioss-parent-pom:version.cui.test.juli.logger       # scope: dependency (property required)
----

The propagation script directly searches for `<version.cui.test.juli.logger>OLD</version.cui.test.juli.logger>` across all POM files in the consumer repo. For `scope: parent`, no hint is needed as the version is always in the `<parent><version>` block.

==== Pyprojectx Section

|===
|Field |Type |Default |Description

|`pyprojectx.python-version` |string |`''` |Python version (empty = let uv manage from pyproject.toml)
|`pyprojectx.cache-dependency-glob` |string |`'uv.lock'` |Glob pattern for uv cache dependencies
|`pyprojectx.upload-artifacts-on-failure` |boolean |`false` |Upload test artifacts on failure
|`pyprojectx.verify-command` |string |`'./pw verify'` |Verification command to run
|===

== Full Example

[source,yaml]
----
# yaml-language-server: $schema=https://raw.githubusercontent.com/cuioss/cuioss-organization/main/.github/actions/read-project-config/schema.json
name: cui-java-tools
description: Java utility library

# Release configuration (read by maven-release.yml)
release:
  current-version: 1.2.0
  next-version: 1.3.0-SNAPSHOT
  create-github-release: true  # Creates GitHub Release with auto-generated notes

# Build configuration (read by maven-build.yml AND maven-release.yml)
maven-build:
  java-versions: '["21","25"]'
  java-version: '21'
  enable-snapshot-deploy: true
  maven-profiles-snapshot: 'release-snapshot,javadoc'
  maven-profiles-release: 'release,javadoc'
  npm-cache: false
  skip-on-docs-only: true         # Skip build when only docs/config changed
  # paths-ignore-extra:           # Additional non-code patterns (uncomment if needed)
  #   - 'e-2-e-playwright/docs/**'

# SonarCloud configuration (read by maven-build.yml)
sonar:
  project-key: cuioss_cui-java-tools
  enabled: true
  skip-on-dependabot: true

# GitHub Pages configuration (read by maven-release.yml)
pages:
  reference: cui-java-tools
  deploy-at-release: true

# GitHub Automation (controls auto-merge of workflow update PRs)
github-automation:
  auto-merge-build-versions: true

# Consumer repos to receive automatic dependency updates on release
# Format: 'repo-name' or 'repo-name:version-property-hint'
consumers:
  - cui-core-ui-model
  - cui-http
  - cuioss-parent-pom:version.cui.java.tools  # optional: target property directly

# Dependency propagation configuration (used with consumers)
dependency-propagation:
  group-id: de.cuioss
  artifact-id: cui-java-tools
  scope: dependency              # 'parent' or 'dependency'
----

== Fallback Behavior

The reusable workflows use a three-tier precedence:

. *Explicit inputs* - Values passed via `with:` in the caller workflow
. *project.yml values* - Values from the consumer repo's `.github/project.yml`
. *Workflow defaults* - Built-in defaults in the reusable workflow

This allows:
- Zero-configuration usage when project.yml is fully populated
- Override specific settings via explicit inputs when needed
- Graceful fallback to sensible defaults

== cuioss-organization Repo Schema

The cuioss-organization repository itself uses a simpler schema:

[source,yaml]
----
name: cuioss-organization
description: Reusable GitHub Actions workflows for cuioss organization

release:
  current-version: 0.1.0
  create-github-release: true  # Creates GitHub Release with auto-generated notes

# Repos that consume these workflows (for automated updates by release.yml)
consumers: []
----

The `consumers` list is used by the release workflow to automatically update consumer repos when a new version is released.

== Validation

Use `yq` to validate your project.yml syntax:

[source,bash]
----
yq eval '.release["current-version"]' .github/project.yml
----

Check required fields:

[source,bash]
----
# Verify release section exists
yq eval '.release' .github/project.yml

# Verify sonar project key
yq eval '.sonar["project-key"]' .github/project.yml
----